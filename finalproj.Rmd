--- 
title: "High School Students Performance Analysis"
author: "Group 6: Weisheng Chen & Zixiang Yin"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

# Introduction


<!--chapter:end:index.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data sources

The dataset used in this project was obtained from UCI Machine Learning Repository(http://archive.ics.uci.edu/ml/datasets/Student+Performance). It was originally generated by Paulo Cortez and then donated to the University of California Irvine database.

## Data Merging
This dataset approches student achievement in secondary education of two Portuguese schools. Two datasets are provided regarding the performance in two distinct subjects: Mathematics (mat) and Portuguese language (por).

## Feature Information
Attributes for both datasets(One for math grade and the other for portuguese grade):

```{r, echo = FALSE}
Description = readr::read_csv(here::here("./data/Description.csv"))
knitr::kable(Description[1:33, ], caption = "Columns and Descriptions",
             row.names = F,font_size = 12)
```

Note: Grades are related with the course subject, Math or Portuguese.

<!--chapter:end:02-data.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Data transformation
```{r,echo=FALSE}
library(ggplot2)
library(dplyr)
library(gridExtra)
library(tidyverse)
library(vcd)
```
## Data Merging
Two datasets are provided regarding two distinct subjects: Mathematics (mat) and Portuguese language (por). \
To combine these two datasets, we spcified the following columns to be used for merging because these columns are basic information of students: \
```{r, echo = FALSE}
Description = readr::read_csv(here::here("./data/Description.csv"))
knitr::kable(Description[c(1:12,20,22), ],
             row.names = F,font_size = 12)
```

## Data Cleaning
After inspecting each variables carefully, we detected that there were outliers in `Age` and abnormal values in Math and Portuguese grades. \
Let's first take a look at the boxplot of age.\
```{r,echo=FALSE}
mat=read.table("./data/student-mat.csv",sep=";",header=TRUE)
por=read.table("./data/student-por.csv",sep=";",header=TRUE)
df=merge(mat,por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet","guardian"))
colnames(df)[colnames(df) == 'G1.x'] = 'Math_G1'
colnames(df)[colnames(df) == 'G2.x'] = 'Math_G2'
colnames(df)[colnames(df) == 'G3.x'] = 'Math_G3'
colnames(df)[colnames(df) == 'G1.y'] = 'Portuguese_G1'
colnames(df)[colnames(df) == 'G2.y'] = 'Portuguese_G2'
colnames(df)[colnames(df) == 'G3.y'] = 'Portuguese_G3'
ggplot(df,aes(x=factor(0),y=age))+geom_boxplot(fill='lightblue')+theme(axis.title.y=element_blank(),axis.text.y=element_blank(),axis.ticks.y=element_blank())+coord_flip()
```

Most students leave secondary school at 16 or 17. There may be some exceptions and age 19 in this dataset seems reasonable. However, we tend to believe that age 20 and 22 are outliers so it is better to remove data which includes age = 20 or age = 22. \
Next, let's move to Math and Portuguese grades in different period. \
```{r,echo=FALSE}
math_long = df %>% pivot_longer(c(Math_G1,Math_G2,Math_G3), names_to = 'Period', values_to = 'Grade')
plot_math = ggplot(math_long,aes(x = Grade)) +
             geom_bar(fill = 'lightblue', color = 'black') +
             facet_wrap(~Period) +
             ggtitle('Histogram of Math Grades faceting by Period')

portuguese_long = df %>% pivot_longer(c(Portuguese_G1,Portuguese_G2,Portuguese_G3), names_to = 'Period', values_to = 'Grade')
plot_portuguese = ggplot(portuguese_long,aes(x = Grade)) +
             geom_bar(fill = 'lightblue', color = 'black') +
             facet_wrap(~Period) +
             ggtitle('Histogram of Portuguese Grades faceting by Period')
grid.arrange(plot_math, plot_portuguese, nrow = 2)
```

We can see there are grades that equal to 0. Usually, a student with bad performance on a course may result in very low grade, but not 0. A grade of 0 usually appears when the student misses the exam or he/she cheats in exam. However, absence from exam or cheating are not part of factors we are studying. Ih this case, we remove all data with grade of 0. 

## Adding New Variable
We created two new variables to represent overall performance on Math and Portuguese for a student as: \
$Math\_Grade = \frac{1}{3}Math\_G1 + \frac{1}{3}Math\_G2 + \frac{1}{3}Math\_G3$ \
$Por\_Grade = \frac{1}{3}Por\_G1 + \frac{1}{3}Por\_G2 + \frac{1}{3}Por\_G3$ \

<!--chapter:end:03-cleaning.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Missing values

```{r, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(patchwork)
```

## Check for Missing values
The plot below shows that there is no missing value in all datasets we use.

```{r mv, echo = F, message = F, fig.height=8, fig.width=8}
# define the plot_missing function
plot_missing <- function(df, percent = F, angle = 0) {
  # generate sub dataframes
  df_main <- data.frame(is.na(df)) %>%
    group_by_all() %>%
    count(name = "n", sort = TRUE) %>%
    ungroup() %>%
    rowwise() %>%
    mutate(alpha = ifelse(all(c_across(-n) == F), 0.2, 0)) %>%
    rownames_to_column("rid") %>%
    mutate(rid = as.factor(as.numeric(rid)))
  df_row <- df_main %>% 
    select_if(negate(is_bare_logical)) %>%
    ungroup() %>%
    mutate(perc = n / sum(n))
  df_col <- colSums(is.na(df)) %>%
    stack() %>%
    rename(key = ind, n = values) %>%
    mutate(perc = n / dim(df)[1],
           key = as.character(key)) %>%
    arrange(-n, key) %>%
    mutate(key = fct_relevel(key, key))
  # generate plots
  if (!percent) {
    p_row_ggplot <- ggplot(df_row, aes(x = fct_rev(rid), y = n, 
                                       fill = as.factor(alpha))) +
                    ylab("row count")
    p_col_ggplot <- ggplot(df_col, aes(x = key, y = n)) +
                    ylim(0, ifelse(dim(df_main)[1] == 1, 20, NA)) +
                    ylab("num rows missing:")
  }
  else {
    p_row_ggplot <- ggplot(df_row, aes(x = fct_rev(rid), 
                                       y = 100 * perc, 
                                       fill = as.factor(alpha))) + 
                    ylim(0, 100) + ylab("% rows")
    p_col_ggplot <- ggplot(df_col, aes(x = key,
                                       y = 100 * perc)) + 
                    ylim(0, 100) + ylab("% rows missing:")
  }
  p_row <- p_row_ggplot +
    geom_bar(stat = "identity", show.legend = F) + 
    scale_fill_manual(values = c("lightblue", "skyblue3")) +
    theme_bw() +
    theme(axis.title.y = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.minor.y = element_blank()) +
    coord_flip()
  p_col <- p_col_ggplot +
    geom_bar(stat = "identity", fill = "lightblue") +
    ggtitle("Missing value patterns") +
    theme_bw() +
    theme(axis.title.x = element_blank(),
          axis.text.x = element_text(angle = angle,
                                     hjust = ifelse(angle, 0.7, 0.5)),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank())
  p_main <- df_main %>%
    select(-n) %>%
    pivot_longer(cols = -c(rid, alpha), names_to = "col", values_to = "missing") %>%
    mutate(missing = as.factor(missing + alpha),
           label = ifelse(missing == 0.2 & col == names(df)[1], 
                          "completed cases", "")) %>%
    #ggplot(aes(x = factor(col, levels = levels(df_col$key)), 
    ggplot(aes(x = fct_relevel(col, levels(df_col$key)), 
               y = fct_rev(rid))) +
    geom_tile(aes(fill = missing), color = "white", show.legend = FALSE) +
    geom_text(aes(x = 0.5 + floor(dim(df)[2] / 2), label = label)) +
    xlab("variable") + 
    ylab("missing pattern") +
    scale_fill_manual(values = c("lightgrey", "darkgrey", "medium purple")) +
    theme_bw() +
    theme(axis.line = element_line(colour = "black"),
          axis.text.x = element_text(angle = angle, 
                                     hjust = ifelse(angle, 0.7, 0.5)),
          panel.grid.major = element_blank(),
          panel.border = element_blank())

  # display plots
  p_col + plot_spacer() + 
    p_main + p_row + 
    plot_layout(heights = c(1, 2.5), widths = c(2.5, 1))
}
student_mat <- read_csv("data/stu-mat.csv")
plot_missing(student_mat, angle = 30)
```

<!--chapter:end:04-missing.Rmd-->

---
output: html_document
editor_options: 
chunk_output_type: console
---
```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Results

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(vcd)
library(HH)
library(here)
library(readr)
```

## Students & Schools Analysis

In this section, we will analyze students' non-academic data and in two schools.

### Age

```{r}
stu <- readr::read_csv(here::here("./data/stu-mat.csv")) %>% 
  mutate(sex = ifelse(sex == "F","Female", "Male"),
         address = ifelse(address == "U","Urban ", "Rural"))
ggplot(stu, aes(factor(age))) +
  geom_bar(color = "black", 
           fill = "lightblue") +
  facet_wrap(~school) +
  xlab("Age") +
  ylab("Frequency") +
  ggtitle("Bar chart for the age by schools") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```
The bar chart plot below displays students' age distribution in the two schools. One of obvious property is that **GP** has much **more** students than **MS**. Precisely, **GP** has a total of `r sum(ifelse(stu$school=="GP",1,0))` students of which accounts for `r round(sum(ifelse(stu$school=="GP",1,0))/dim(stu)[1],4)*100`% of the dataset. Possibly due to the small number of students, age range is more narrow in **MS** (17-21) than that in **GP** (15-22).

In order to compare the age distribution effectively, we calculate relative frequency plot below.

```{r}
stu %>% 
  count(school, age) %>% 
  ungroup() %>% 
  group_by(school) %>% 
  mutate(per = n / sum(n)) %>% 
  dplyr::select(-n) %>% 
  ungroup() %>% 
  add_row(school = c("GP","MS","MS","MS"), 
          age = c(21, 15, 16, 22), 
          per = c(0, 0, 0, 0)) %>% 
  ggplot(aes(factor(age), per * 100, fill = school)) + 
    geom_bar(stat='identity', position = "dodge")  + 
    xlab("Age") +
    ylab("Relative frequency in %") +
    ggtitle("Bar chart for the age by schools") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank())
```
In the relative frequency plot, it is clear that students in **GP** are generally younger that in **MS**. In addition, age distribution in **MS** is centered that age group 18 is an absolute majority while age distribution in **GP** is spread that no age group accounts for more than thirty percent.

### Family Education Level

In this section, we will analyze the students' family education level in the two schools. Since the dataset offers the education level of both parents, we will use the higher one to indicate the family education level of a student, i.e. `max(Medu, Fedu)`.

```{r}
HH::likert(Pedu~., 
           stu %>%  mutate(Pedu = pmax(Medu, Fedu)) %>%
             count(school, Pedu, name = "Freq") %>% 
             pivot_wider(names_from = school, 
                         values_from = Freq) %>% 
             mutate(GP = 100 * GP / sum(GP),
                    MS = 100 * MS / sum(MS)),
           positive.order = TRUE,
           main = "Family education level in two schools",
           xlab = "percent", ylab = "")
```
According to the plot above, we can find that students' failmy education level in **GP** is generally higher that in **MS**.

### Sex & Address

In this section, we are going to look at the students' distribution interms of their gender and home address type (Urban or Rural).

```{r}
HH::likert(grp~., 
           union(stu %>% 
                   count(school, sex) %>% 
                   pivot_wider(names_from = school, values_from = n) %>% 
                   rename(grp = sex) %>% 
                   mutate(GP = 100 * GP / sum(GP),
                          MS = 100 * MS / sum(MS)),
                 stu %>% 
                   count(school, address) %>% 
                   pivot_wider(names_from = school, values_from = n) %>% 
                   rename(grp = address) %>% 
                   mutate(GP = 100 * GP / sum(GP),
                          MS = 100 * MS / sum(MS))),
           positive.order = TRUE,
           main = "% of gender and address in two schools",
           xlab = "percent", ylab = "")
```

In terms of gender, there is nearly no difference between two schools. Both **GP** and **MS** have a **half-half** gender distribution. However, only 20% students in **GP** are from rural area while there is no significance difference in students' address type in **MS**.

### Reason of Chosing School

In this section, we are going to multivariate analysis in terms of the association between schools, reasons, and family education level.

#### Reason & School

According to the plot below, there is association between schools and reasons. The **Pearson's Chi-squared** test rejects the hypothesis that two variables are not relevant with a p-value of 0.006, which is consistent with our observation.

Consequently, we can obtain that **GP** has a better reputation in terms of reason of choice while course offered by **MS** is more attractive.

```{r}
mosaic(reason ~ school, 
       stu %>% count(school, reason, name = "Freq"), 
       direction = c("v", "h"))
```

#### Reason Adr

According to the plot below, rural students are more likely to choose **MS** other than **GP** due to `home` and `other` reasons. A possible explanation would be **MS**'s study schedule is flexible. On the other hand, urban students tend to choose **MS** more often than **GP** because of `course`.

```{r}
mosaic(reason ~ address + school, 
       stu %>% count(school, reason, address, name = "Freq"), 
       direction = c("v", "v", "h"))
```

<!--chapter:end:05-results.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Interactive component



<!--chapter:end:06-interactive.Rmd-->

```{r include=FALSE, cache=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```
# Conclusion


<!--chapter:end:07-conclusion.Rmd-->


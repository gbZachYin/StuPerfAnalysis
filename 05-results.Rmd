---
output: html_document
editor_options: 
chunk_output_type: console
---
# Results

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(vcd)
library(HH)
library(here)
library(readr)
```

## Students & Schools Analysis

In this section, we will analyze students' non-academic data and in two schools.

### Age

```{r}
stu <- readr::read_csv(here::here("./data/stu-mat.csv")) %>% 
  mutate(sex = ifelse(sex == "F","Female", "Male"),
         address = ifelse(address == "U","Urban ", "Rural"))
ggplot(stu, aes(factor(age))) +
  geom_bar(color = "black", 
           fill = "lightblue") +
  facet_wrap(~school) +
  xlab("Age") +
  ylab("Frequency") +
  ggtitle("Bar chart for the age by schools") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank())
```
The bar chart plot below displays students' age distribution in the two schools. One of obvious property is that **GP** has much **more** students than **MS**. Precisely, **GP** has a total of `r sum(ifelse(stu$school=="GP",1,0))` students of which accounts for `r round(sum(ifelse(stu$school=="GP",1,0))/dim(stu)[1],4)*100`% of the dataset. Possibly due to the small number of students, age range is more narrow in **MS** (17-21) than that in **GP** (15-22).

In order to compare the age distribution effectively, we calculate relative frequency plot below.

```{r}
stu %>% 
  count(school, age) %>% 
  ungroup() %>% 
  group_by(school) %>% 
  mutate(per = n / sum(n)) %>% 
  dplyr::select(-n) %>% 
  ungroup() %>% 
  add_row(school = c("GP","MS","MS","MS"), 
          age = c(21, 15, 16, 22), 
          per = c(0, 0, 0, 0)) %>% 
  ggplot(aes(factor(age), per * 100, fill = school)) + 
    geom_bar(stat='identity', position = "dodge")  + 
    xlab("Age") +
    ylab("Relative frequency in %") +
    ggtitle("Bar chart for the age by schools") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.major.x = element_blank(),
          panel.grid.minor.x = element_blank())
```
In the relative frequency plot, it is clear that students in **GP** are generally younger that in **MS**. In addition, age distribution in **MS** is centered that age group 18 is an absolute majority while age distribution in **GP** is spread that no age group accounts for more than thirty percent.

### Family Education Level

In this section, we will analyze the students' family education level in the two schools. Since the dataset offers the education level of both parents, we will use the higher one to indicate the family education level of a student, i.e. `max(Medu, Fedu)`.

```{r}
HH::likert(Pedu~., 
           stu %>%  mutate(Pedu = pmax(Medu, Fedu)) %>%
             count(school, Pedu, name = "Freq") %>% 
             pivot_wider(names_from = school, 
                         values_from = Freq) %>% 
             mutate(GP = 100 * GP / sum(GP),
                    MS = 100 * MS / sum(MS)),
           positive.order = TRUE,
           main = "Family education level in two schools",
           xlab = "percent", ylab = "")
```
According to the plot above, we can find that students' failmy education level in **GP** is generally higher that in **MS**.

### Sex & Address

In this section, we are going to look at the students' distribution interms of their gender and home address type (Urban or Rural).

```{r}
HH::likert(grp~., 
           union(stu %>% 
                   count(school, sex) %>% 
                   pivot_wider(names_from = school, values_from = n) %>% 
                   rename(grp = sex) %>% 
                   mutate(GP = 100 * GP / sum(GP),
                          MS = 100 * MS / sum(MS)),
                 stu %>% 
                   count(school, address) %>% 
                   pivot_wider(names_from = school, values_from = n) %>% 
                   rename(grp = address) %>% 
                   mutate(GP = 100 * GP / sum(GP),
                          MS = 100 * MS / sum(MS))),
           positive.order = TRUE,
           main = "% of gender and address in two schools",
           xlab = "percent", ylab = "")
```

In terms of gender, there is nearly no difference between two schools. Both **GP** and **MS** have a **half-half** gender distribution. However, only 20% students in **GP** are from rural area while there is no significance difference in students' address type in **MS**.

### Reason of Chosing School

In this section, we are going to multivariate analysis in terms of the association between schools, reasons, and family education level.

#### Reason & School

According to the plot below, there is association between schools and reasons. The **Pearson's Chi-squared** test rejects the hypothesis that two variables are not relevant with a p-value of 0.006, which is consistent with our observation.

Consequently, we can obtain that **GP** has a better reputation in terms of reason of choice while course offered by **MS** is more attractive.

```{r}
mosaic(reason ~ school, 
       stu %>% count(school, reason, name = "Freq"), 
       direction = c("v", "h"))
```

#### Reason Adr

According to the plot below, rural students are more likely to choose **MS** other than **GP** due to `home` and `other` reasons. A possible explanation would be **MS**'s study schedule is flexible. On the other hand, urban students tend to choose **MS** more often than **GP** because of `course`.

```{r}
mosaic(reason ~ address + school, 
       stu %>% count(school, reason, address, name = "Freq"), 
       direction = c("v", "v", "h"))
```

## Factors Affecting Students' Academic Performance

In this section, we will analyze factors that affect students' academic performance. Given that we have more than 40 variables in our dataset and all of them are categorical variables after conversion, we decide to use Pearson's Chi-squared Test to help us narrow down our variable list to be analyzed later. Here we are using the final letter grade(Math_Letter_Grade and Por_Letter_Grade which is converted from G3 based on the grading system in Portugal) for both Math and Portuguese to reflect student's academic performance. For each variable in our dataset, we do a Pearson's Chi-squared Test to see if there is an association between the variable and Math_Letter_Grade or Portuguese_Letter_Grade. We set alpha = 0.01 and the test suggests the following variable list that may have strong relationship with student's academic performance: \
Variables that may affect on students' math grade: 
```{r}
mat=read.table("./data/student-mat.csv",sep=";",header=TRUE)
por=read.table("./data/student-por.csv",sep=";",header=TRUE)
df=merge(mat,por,by=c("school","sex","age","address","famsize","Pstatus","Medu","Fedu","Mjob","Fjob","reason","nursery","internet","guardian"))
colnames(df)[colnames(df) == 'G1.x'] = 'Math_G1'
colnames(df)[colnames(df) == 'G2.x'] = 'Math_G2'
colnames(df)[colnames(df) == 'G3.x'] = 'Math_G3'
colnames(df)[colnames(df) == 'G1.y'] = 'Portuguese_G1'
colnames(df)[colnames(df) == 'G2.y'] = 'Portuguese_G2'
colnames(df)[colnames(df) == 'G3.y'] = 'Portuguese_G3'
df = df[df$age<20 & df$Math_G2 != 0 & df$Math_G3 != 0 & df$Portuguese_G1 != 0 & df$Portuguese_G3!=0,]
df = df %>% mutate(Math_Grade = round((1/3)*Math_G1+(1/3)*Math_G2+(1/3)*Math_G3,2), Por_Grade = round((1/3)*Portuguese_G1+(1/3)*Portuguese_G2+(1/3)*Portuguese_G3,2))
df = df %>% mutate(Math_Letter_Grade = case_when(Math_G3 >= 18 & Math_G3 <= 20 ~ 'A',
                                        Math_G3 >= 14 & Math_G3 < 18 ~ 'B',
                                        Math_G3 >= 10 & Math_G3 < 14 ~ 'C',
                                        Math_G3 >= 4 & Math_G3 < 10 ~ 'D',
                                        Math_G3 >= 0 & Math_G3 < 4 ~ 'F' ),
         Por_Letter_Grade = case_when(Portuguese_G3 >= 18 & Portuguese_G3 <= 20 ~ 'A',
                                        Portuguese_G3 >= 14 & Portuguese_G3 < 18 ~ 'B',
                                        Portuguese_G3 >= 10 & Portuguese_G3 < 14 ~ 'C',
                                        Portuguese_G3 >= 4 & Portuguese_G3 < 10 ~ 'D',
                                        Portuguese_G3 >= 0 & Portuguese_G3 < 4 ~ 'F' ),
         absences.x = case_when(absences.x == 0 ~ '0',
                                absences.x >0 & absences.x <= 2 ~ '1',
                                absences.x >2 & absences.x <= 4 ~ '2',
                                absences.x >4 & absences.x <= 8 ~ '3',
                                absences.x >8 ~ '4'),
         absences.y = case_when(absences.y == 0 ~ '0',
                                absences.y >0 & absences.y <= 2 ~ '1',
                                absences.y >2 & absences.y <= 4 ~ '2',
                                absences.y >4 ~ '3'))
test = function(x, course){
  l = c()
  for(i in 1:(ncol(x)-1)){
    if(chisq.test(x[,i],x[,ncol(x)])$p.value < 0.01){
      l = append(l,i)
    }
  }
  return(l)
}
Math_cor = df[,c(1:30,55)]
colnames(Math_cor) = str_remove(colnames(Math_cor),'\\.x')
Por_cor = df[,c(1:14,34:49,56)]
colnames(Por_cor) = str_remove_all(colnames(Por_cor),'\\.y')
list_math = test(Math_cor,'Math_Grade')
list_por = test(Por_cor)
colnames(Math_cor)[list_math]
```

Variables that may affect students' Portuguese grade: \
```{r}
colnames(Por_cor)[list_por]
```

Now we can dig deeper into these variables one by one. 

### Variables Relating to Math Grade

```{r}
p1 = grid.grabExpr(mosaic(Medu ~ Math_Letter_Grade, Math_cor, direction = c("v", "h")))
p2 = grid.grabExpr(mosaic(failures ~ Math_Letter_Grade, Math_cor, direction = c("v", "h")))
p3 = grid.grabExpr(mosaic(schoolsup ~ Math_Letter_Grade, Math_cor, direction = c("v", "h")))
p4 = grid.grabExpr(mosaic(absences ~ Math_Letter_Grade, Math_cor, direction = c("v", "h")))
grid.arrange(p1,p2,ncol=2)
```

`Medu` (mother’s education:0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education): The mosaic plot shows a strong relationship between `Medu` and `Math_Letter_Grade`. When the education for a student's mother is in level 3 or 4, the student is more likely to get a better grade(A or B). The is saying that, a student's mother with high level education can be helpful to the student's achievement on math.\
`failures` (number of past class failures: n if 1<=n<3, else 4): The mosaic plot shows that for students who got a grade of A or B, most of them never failed any courses, and few of them failed no more than 2 courses in the past. However, the proportion of students who failed more than 3 courses in the past increases rapidly in the class of grade C or D. This is a logical truth that a student with failures in the past class is prone to get lower grade in the future class.\

```{r}
grid.arrange(p3,p4,ncol=2)
```
`schoolsup`(extra educational support): It is clear that, the proportion of students who get extra educational support increases when `Math_Letter_Grade` goes from A to D. This seems reasonable because only those students who got low grade need extra educational support to help them improve.\
`absences` (absences from school:0 - none, 1 - less than first quantile, 2 - less than second quantile, 3 - less than thrid quantile, 4 - more than third quantile): The plot shows something unexpected. If we only focus on grade B, C and D, it indicates a trend that, fewer absences from school leads to higher grade in math class. But when we move to grade A, a reverse trend applies. We can see that students with grade A are more likely to be absent from school than students with grade B. \

### Variables Relating to Portuguese Grade
```{r,warning=FALSE}
p5 = grid.grabExpr(mosaic(Medu ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p6 = grid.grabExpr(mosaic(studytime ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p7 = grid.grabExpr(mosaic(failures ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p8 = grid.grabExpr(mosaic(schoolsup ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p9 = grid.grabExpr(mosaic(higher ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p10 = grid.grabExpr(mosaic(freetime ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p11 = grid.grabExpr(mosaic(goout ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p12 = grid.grabExpr(mosaic(Dalc ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
p13 = grid.grabExpr(mosaic(health ~ Por_Letter_Grade, Por_cor,direction = c("v","h")))
grid.arrange(p5,p6, ncol = 2)
```

`Medu` (mother’s education:0 - none, 1 - primary education (4th grade), 2 - 5th to 9th grade, 3 - secondary education or 4 - higher education): From the mosaic plot, we can see that the majority of students got grade in class B, C and D. If we focus on these classes only, the proportion of students whose mother's education is in level 3 or 4 decreases as we move from class B to class D(so as the proportion of `Medu` = 0 ,1, 2 increases). On the other hand, class A does not seem to follow this trend. However, given that the number of students who got grade A is only 11 and we have 333 students in total, we may need more data to analyze the hidden reason. But it is clear that, the proportion of `Medu` = 3 or 4(high level education) in class A is relatively high compared to class D and F. In conclusion, we expect to see a student to get a higher grade if his/her mother has received high level education. \
`studytime` (weekly study time: 1 - < 2 hours, 2 - 2 to 5 hours, 3 - 5 to 10 hours, or 4 - >10 hours): The plot reveals that students with higher grade used to spend more time on study. And this is intuitively correct as students spend more time on study, it will increase their knowledge and self-assurance to score higher grade. \

```{r}
grid.arrange(p7,p8,ncol=2)
```

`failures` (number of past class failures: n if 1<=n<3, else 4): There is a same trend as how `failures` affect students' performance on math. We can't see much difference in class A and class B regarding the proportion of different class of `failures`. When we move to class C, D and F, the number of students who failed more than 2 classes in the past increases dramatically. Hence, here 's the same idea that a student with failures in the past class is prone to get lower grade in the future class. \
`schoolsup`(extra educational support): Same as the relationship between `schoolsup` and `Math_Letter_Grade`, the proportion of students who get extra educational support increases when `Por_Letter_Grade` goes from A to D. This seems reasonable because only those students who got low grade need extra educational support to help them improve. \

```{r}
grid.arrange(p9,p10,ncol=2)
```

`higher` (wants to take higher education): The plot shows that students who do not want to pursue a higher level education finally got grade C or D. We cannot say much about a student who want to take higher education, because he/she is equal likely to get grade A, B or C given that the proportion of `higher = yes` is almost the same in grade A, B and C. However, if a student do not want to take higher education, our data supports that he/she is likely to get a grade C or D. Grade F may be an exception here and we cannot conclude anything for it given that there is only one student get grade F. \
`freetime` (free time after school: from 1 - very low to 5 - very high): There is no clear trend to show how `freetime` affects students' grade on Protuguese language. Class B and Class C looks almost the same. Interesting fact is that, there is a boost on students' free time after school when we move to A, D or F, which indicates that big increment in `freetime` may reflect two total different situations: either a student did well in Portuguese exam or a student got low grade(D or F) in the exam. A possible explanation is that, generally, students with grade A study more strategically which increases their study efficiency and save more time on finishing their homework, so have more free time compared to students with grade B and C who spend more time on study with low efficiency so have less free time. And for students with grade D and F, they just spend few time on study so have more free time. \

```{r}
grid.arrange(p11,p12,ncol=2)
```

`goout` (going out with friends: from 1 - very low to 5 - very high): There is a clear trend that students who often going out with friends(`goout = 4 or 5`) are less likely to get high grade on Portuguese languange exam. \
`Dalc` (workday alcohol consumption: from 1 - very low to 5 - very high): The mosaic plot shows that the proportion of `Dalc = 3, 4 or 5` increases rapidly in students with grade B, C, D and F which indicates that increment in alcohol consumption in workday will have negative impact on students' performance on Portuguese. \

```{r}
grid.arrange(p13)
```

`health` (current health status: from 1 - very bad to 5 - very good): There is a strong relationship between `health` and `Por_Letter_Grade`. As students with higher grade, they may tend to be more stressful regarding their study. Moreover, as what we discovered before, students with higher grade have longer weekly study time. Hence, unsurprisingly, we expect to see that students with higher grade have worse health condition than those with lower grade, as spending more time on study and having more stress make negative impact on both physical and mental health.\